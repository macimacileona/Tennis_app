{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
{% set active_tab = request.args.get('active_tab', 'users') %}
<div class="container mt-5 position-relative">
  <!-- Back to Landing Page Button (top right) -->
  <div class="position-absolute" style="top: 0; right: 0;">
    <a href="{{ url_for('home') }}" class="btn btn-secondary">Back to Landing Page</a>
  </div>
  
  <h2 class="mt-3">Admin Dashboard</h2>
  
  <!-- Outer Tabs: Users, Players, Create Competition -->
  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab=='users' %}active{% endif %}" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="{% if active_tab=='users' %}true{% else %}false{% endif %}">
        Users
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab=='players' %}active{% endif %}" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab" aria-controls="players" aria-selected="{% if active_tab=='players' %}true{% else %}false{% endif %}">
        Players
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab=='competition' %}active{% endif %}" id="competition-tab" data-bs-toggle="tab" data-bs-target="#competition" type="button" role="tab" aria-controls="competition" aria-selected="{% if active_tab=='competition' %}true{% else %}false{% endif %}">
        Create Competition
      </button>
    </li>
  </ul>
  
  <div class="tab-content" id="adminTabContent">
    <!-- Users Tab -->
    <div class="tab-pane fade {% if active_tab=='users' %}show active{% endif %}" id="users" role="tabpanel" aria-labelledby="users-tab">
      <div class="table-responsive mt-3">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Username</th>
              <th>Year of Birth</th>
              <th>Total Matches</th>
              <th>Win</th>
              <th>Loss</th>
              <th>Win %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>
                <a href="{{ url_for('profile_by_username', username=user.username) }}">
                  {{ user.username }}
                </a>
              </td>
              <td>{{ user.birth_year }}</td>
              <td>0</td>
              <td>0</td>
              <td>0</td>
              <td>0%</td>
              <td>
                {% if not user.participant %}
                  <a href="{{ url_for('add_participant', user_id=user.id) }}" class="btn btn-success btn-sm">Add Player</a>
                {% else %}
                  <a href="{{ url_for('remove_participant', user_id=user.id) }}" class="btn btn-warning btn-sm">Remove Player</a>
                {% endif %}
                <a href="{{ url_for('freeze_participant', user_id=user.id) }}" class="btn btn-danger btn-sm">Freeze Player</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Players Tab -->
    <div class="tab-pane fade {% if active_tab=='players' %}show active{% endif %}" id="players" role="tabpanel" aria-labelledby="players-tab">
      <div class="table-responsive mt-3">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Player Name</th>
              <th>Year of Birth</th>
              <th>Total Matches</th>
              <th>Win</th>
              <th>Loss</th>
              <th>Win %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for participant in participants %}
            <tr>
              <td>
                <a href="{{ url_for('profile_by_username', username=participant.username) }}">
                  {{ participant.first_name }} {{ participant.last_name }}
                </a>
              </td>
              <td>{{ participant.birth_year }}</td>
              <td>0</td>
              <td>0</td>
              <td>0</td>
              <td>0%</td>
              <td>
                <a href="{{ url_for('remove_participant', user_id=participant.id) }}" class="btn btn-warning btn-sm">Remove Player</a>
                <a href="{{ url_for('freeze_participant', user_id=participant.id) }}" class="btn btn-danger btn-sm">Freeze Player</a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center">No participants added yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Create Competition Tab -->
    <div class="tab-pane fade {% if active_tab=='competition' %}show active{% endif %}" id="competition" role="tabpanel" aria-labelledby="competition-tab">
      <div class="mt-3">
        <p>Total number of players: <strong>{{ participants|length }}</strong></p>
        <!-- Button to open competition creation modal -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#competitionModal">Create Competition</button>
      </div>
      <hr>
      <h3>Existing Competitions</h3>
      <!-- Nested tabs for each competition -->
      {% if competitions %}
        <ul class="nav nav-tabs mt-3" id="compNav" role="tablist">
          {% for comp in competitions %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if loop.first %}active{% endif %}" id="comp-{{ comp.id }}-tab" data-bs-toggle="tab" data-bs-target="#comp-{{ comp.id }}" type="button" role="tab" aria-controls="comp-{{ comp.id }}" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                {{ comp.name }}
              </button>
            </li>
          {% endfor %}
        </ul>
        <div class="tab-content mt-3" id="compNavContent">
          {% for comp in competitions %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="comp-{{ comp.id }}" role="tabpanel" aria-labelledby="comp-{{ comp.id }}-tab">
              {% set groupLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
              {% for i in range(comp.num_groups) %}
                {% set groupName = "Group " + groupLetters[i] %}
                <div class="mt-3">
                  <h5>{{ groupName }}</h5>
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Player</th>
                        <th>Score</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="2" class="text-center">No players assigned yet.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No competitions created yet.</p>
      {% endif %}

      <!-- Bootstrap Modal for Competition Creation Form -->
      <div class="modal fade" id="competitionModal" tabindex="-1" aria-labelledby="competitionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form action="{{ url_for('create_competition') }}" method="POST" id="competitionForm">
              <div class="modal-header">
                <h5 class="modal-title" id="competitionModalLabel">Create Competition</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="compName" class="form-label">Competition Name</label>
                  <input type="text" class="form-control" id="compName" name="compName" required>
                </div>
                <div class="mb-3">
                  <label for="numGroups" class="form-label">Number of Groups</label>
                  <input type="number" class="form-control" id="numGroups" name="numGroups" min="1" required>
                </div>
                <div class="mb-3">
                  <label for="maxPlayers" class="form-label">Maximum Number of Players in One Group</label>
                  <input type="number" class="form-control" id="maxPlayers" name="maxPlayers" min="1" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Competition</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div> <!-- End Create Competition Tab -->
  </div>
</div>
{% endblock %}
